{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="{% static 'cm_site/img/logo.svg' %}">
    <link rel="stylesheet" href="{% static 'cm_site/css/reset.css' %}">
    <link rel="stylesheet" href="{% static 'cm_site/css/font.css' %}">
    <link rel="stylesheet" href="{% static 'cm_site/css/store.css' %}">
    <title>CloudyMotion | Store</title>
</head>
<body>
    <!-- Оболочка -->
    <div class="wrapper">
        <!-- шапка -->
        <header class="header">
            <div class="header__container">
                <a href="{% url 'home' %}">
                    <div class="header__container-logo"></div>
                </a>
                    {% if user.is_authenticated %}
                        <!-- Навигация после аунтефикации -->
                        <div class="header__container-navbar">
                            <a href="" class="navbar__link">
                                <div class="navbar__link-home">Home</div>
                            </a>
                            <a href="" class="navbar__link">
                                <div class="navbar__link-services">Services</div>
                            </a>
                            <a href="" class="navbar__link">
                                <div class="navbar__link-contacts">Contacts</div>
                            </a>
                            <a href="" class="navbar__link navbar__link--svg">
                                <div class="navbar__link-account"></div>
                            </a>
                            <a href="" class="navbar__link navbar__link--svg">
                                <div class="navbar__link-basket"></div>
                            </a>
                        </div>
                    {% else %}
                        <!-- Навигация без аунтификации -->
                        <div class="header__container-navbar header__container-navbar--no">
                            <a href="" class="navbar__link">
                                <div class="navbar__link-home">Home</div>
                            </a>
                            <a href="{% url 'account_login' %}" class="navbar__link">
                                <div class="navbar__link-singin">Sign In</div>
                            </a>
                            <div class="navbar__link navbar__link-sep">
                                <div id="item1" class="navbar__link-sep">|</div>
                            </div>
                            <a href="{% url 'account_signup' %}" class="navbar__link">
                                <div class="navbar__link-singup">Sign Up</div>
                            </a>
                            <a href="" class="navbar__link navbar__link--svg">
                                <div class="navbar__link-basket"></div>
                            </a>
                        </div>
                    {% endif %}
            </div>
        </header>
        <!-- Главная часть -->
        <main class="main">
            <div class="main__container">
                <!-- Баннеры -->
                <div class="main__container_banners">
                    <div class="main__container_banners-carousel">
                        {% for banner in banners %}
                            <div class="carousel__slide">
                                <img src="../media/{{banner.banner}}" alt="banner.jpg">
                            </div>
                        {% endfor %}
                    </div>
                </div>
                <!-- Поисковик и фильтр -->
                <div class="main__container_sort">
                    <!-- Поисковик -->
                    <div class="main__container_sort-search">
                        <form method="post">
                            {% csrf_token %}
                            {{ search_form.text_field }}
                            <button class="search__submit" type="submit"><div></div></button>
                        </form>
                    </div>
                    <!-- Фильтр -->
                    <div class="main__container_sort-filter"></div>
                </div>
                <!-- Плейлист -->
                <div class="main__container_playlist">
                    {% for element in tracks %}
                        <div class="music">
                            <div class="music__cover" onclick="coverPlay({{forloop.counter}});" style="background: url('../media/{{element.cover_art}}') no-repeat; background-size: cover;">
                                <div class="music__cover_button"></div>
                            </div>
                            <div class="music__data">
                                <div class="music__data-main">
                                    <h2>{{element.bpm}} BPM</h2>
                                    <h2>·</h2>
                                    <h2>Key {{element.key}}</h2>
                                    <h2>·</h2>
                                    <h3>{{prices.wav_license}}$</h3>
                                </div>
                                <div class="music__data-name">
                                    <h1><a href="{% url 'store' %}{{element.id}}/{{element.track_name}}/">{{element.track_name}}</a></h1>
                                </div>
                                <div class="music__data-typebeat">
                                    <h2>{{element.type_beat}} Type Beat</h2>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </main>
        <!-- Подвал -->
        <footer class="footer">
            <div class="footer__container">
                <div class="footer__container_up">
                    <a href="{% url 'home' %}">
                        <div class="footer__container_up-logo"></div>
                    </a>
                    <div class="footer__container_up-items1">
                        <a href="">Home</a>
                        <a href="">Store</a>
                        <a href="">Accounts</a>
                        <a href="">Services</a>
                    </div>
                    <div class="footer__container_up-items2">
                        <a href="">Cart</a>
                        <a href="">About</a>
                        <a href="">Contact us</a>
                        <a href="">Support</a>
                    </div>
                    <div class="footer__container_up-items3">
                        <a href="">Beats</a>
                        <a href="">Custom beats</a>
                        <a href="">Mixing & mastering</a>
                        <a href="">Custom projects</a>
                    </div>
                    <div class="footer__container_up-items4">
                        <a href="">Agreement</a>
                        <a href="">Beat Licencing</a>
                        <a href="">Whish list</a>
                        <a href="">Your orders</a>
                    </div>
                </div>
                <div class="footer__container_line"></div>
                <div class="footer__container_down">
                    <div class="footer__container_down-social">
                        <a href=""><div class="instagram"></div></a>
                        <a href=""><div class="youtube"></div></a>
                        <a href=""><div class="telegram"></div></a>
                        <a href=""><div class="discord"></div></a>
                        <a href=""><div class="email"></div></a>
                    </div>
                    <div class="footer__container_down-copyright">
                        ©Copyright Cloudy Motion
                    </div>
                    <div class="footer__container_down-logo">

                    </div>
                </div>
            </div>
        </footer>

        <!-- Плеер -->
        <div class="player">
            <!-- Звук -->
            <!-- <audio class="player__audio" src="../../../../../old/audio/antisocial/track.mp3"></audio> -->
            <!-- <audio class="player__audio" preload="auto" controls> -->
            <audio class="player__audio" preload="auto">
                <source src="" type="audio/mpeg">
            </audio>
            <!-- Прогресс бар -->
            <div class="player__progress">
                <div class="progress"></div>
            </div>
            <!-- Главная оболочка -->
            <div class="player-wrapper">
                <div class="player__container">
                    <!-- Левая часть -->
                    <div class="player__container_data">
                        <div class="player__container_data-music">
                            <div class="player-cover" style="background: url('../../../media/uploads/preview_9qSc1UG.jpg') no-repeat; background-size: cover;"></div>
                            <div class="player-data">
                                <div class="player-name">
                                    Extendo Clip
                                </div>
                                <div class="player-type">
                                    Lil Loaded type beat
                                </div>
                            </div>
                        </div>
                        <div class="extra-b">

                        </div>
                    </div>
                    <!-- Центральная часть -->
                    <div class="player__container_buttons">
                        <button class="random"></button>
                        <button class="back"></button>
                        <button class="play"></button>
                        <button class="forward"></button>
                        <button class="repeat"></button>
                    </div>
                    <!-- Правая часть -->
                    <div class="player__container_other">
                        <button class="other-buy">
                            <img src="../../static/cm_site/img/p-buy.svg" alt="">
                            <div>{{prices.wav_license}}$</div>
                        </button>
                        <div class="player-volume">
                            <div class="volume-ico"></div>
                            <!-- <div class="volume"></div> -->
                            <input class="volume" type="range" id="volumeControl" min="0" max="1" step="0.01" value="1">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Скрипт плеера -->
    <script>
        // Получение блоков
        const progressContainer = document.querySelector('.player__progress');
        const volumeControlIco = document.querySelector('.volume-ico');
        const typeBeat = document.querySelector('.player-type');
        const volumeControl = document.querySelector('.volume');
        const audio = document.querySelector('.player__audio');
        const cover = document.querySelector('.player-cover');
        const progress = document.querySelector('.progress');
        const title = document.querySelector('.player-name');
        const nextBtn = document.querySelector('.forward');
        const randBtn = document.querySelector('.random');
        const player = document.querySelector('.player');
        const repBtn = document.querySelector('.repeat');
        const playBtn = document.querySelector('.play');
        const prevBtn = document.querySelector('.back');
        
        // Переменная с треками 
        const songs = [
            {% for element in tracks %}
                {
                    name: "{{element.track_name}}",
                    typeBeat: "{{element.type_beat}} Type Beat",
                    cover: "../media/{{element.cover_art}}",
                    mp3: "../media/{{element.mp3}}"
                },
            {% endfor %}
        ];
        // Начальная композиция
        let songIndex = 0;
        // Функция инициализации
        function loadSong(songIndex){
            title.innerHTML = songs[songIndex].name;
            typeBeat.innerHTML = songs[songIndex].typeBeat;
            audio.src = songs[songIndex].mp3;
            audio.load();
            cover.style.background = "url(" + songs[songIndex].cover + ")";
            cover.style.backgroundSize = "cover";
            cover.style.backgroundRepeat = "no-repeat";
        }
        // init
        loadSong(songIndex);
        // Запуск Трека
        function playSong(){
            player.classList.add('playSong');
            audio.play();
            playBtn.style.background = "url(../../static/cm_site/img/p-pp.svg)";
        }
        // Пауза
        function pauseSong(){
            player.classList.remove('playSong');
            audio.pause();
            playBtn.style.background = "url(../../static/cm_site/img/p-p.svg)";
        }
        // Кнопка play
        playBtn.addEventListener('click', () => {
            const isPlaying = player.classList.contains('playSong');
            if (isPlaying){
                pauseSong();
            } else {
                playSong();
            }
        });
        // Кнопка рандома
        let isRand = false;
        function randHandler(){
            if (isRand){
                isRand = false;
                randBtn.style.background = "url('../../static/cm_site/img/p-random.svg')";
                randBtn.style.backgroundSize = "cover";
                randBtn.style.backgroundRepeat = "no-repeat";
            } else {
                isRand = true;
                randBtn.style.background = "url('../../static/cm_site/img/randActive.svg')";
                randBtn.style.backgroundSize = "cover";
                randBtn.style.backgroundRepeat = "no-repeat";
            }
        }
        randBtn.addEventListener('click', randHandler);
        // Кнопка повтора
        let isRep = false;
        function repHandler(){
            if (isRep){
                isRep = false;
                repBtn.style.background = "url('../../static/cm_site/img/p-repeat.svg')";
                repBtn.style.backgroundSize = "cover";
                repBtn.style.backgroundRepeat = "no-repeat";
            } else {
                isRep = true;
                repBtn.style.background = "url('../../static/cm_site/img/repActive.svg')";
                repBtn.style.backgroundSize = "cover";
                repBtn.style.backgroundRepeat = "no-repeat";
            }
        }
        repBtn.addEventListener('click', repHandler);
        audio.addEventListener("ended", function() {
            if (isRep){
                audio.currentTime = 0;
                audio.play();
            }
            else{
                nextSong();
            }
        });
        // Кнопка next
        function nextSong(){
            songIndex++;
            if (songIndex > songs.length - 1){
                songIndex = 0;
            }
            if (isRand){
                songIndex = Math.floor(Math.random() * songs.length);
            }
            loadSong(songIndex);
            playSong();
        }
        nextBtn.addEventListener('click', nextSong);
        // Кнопка prev
        function prevSong(){
            songIndex--;
            if (songIndex < 0){
                songIndex = songs.length - 1;
            }
            if (isRand){
                songIndex = Math.floor(Math.random() * songs.length);
            }
            loadSong(songIndex);
            playSong();
        }
        prevBtn.addEventListener('click', prevSong);

        // Движение прогресс-бара
        function updateProgress(e){
            const {duration, currentTime} = e.srcElement;
            const progressPercent = (currentTime / duration) * 100;
            progress.style.width = progressPercent + "%";
        }
        audio.addEventListener('timeupdate', updateProgress);

        // Гадость
        let isPlaying = false; 
        audio.addEventListener('play', function () {
            isPlaying = true;
        });
        audio.addEventListener('pause', function () {
            isPlaying = false;
        });
        function setProgress(e) {
            const width = this.clientWidth;
            const clickX = e.offsetX;
            const duration = audio.duration;
            const userCurrentTime = (clickX / width) * duration;
            const audioCurrentTime = audio.currentTime;
            const progressWidth = progress.style.width;
            progressContainer.removeEventListener('click', setProgress);
            if (isPlaying) {
                audio.pause();
                for (let index = 0; index < 30; index++) {
                    audio.load();           
                }
                audio.currentTime = userCurrentTime;
                
                audio.play();
            } else {
                for (let index = 0; index < 30; index++) {
                    audio.load();                    
                }
                console.log('DON`T PLAY');
                audio.currentTime = userCurrentTime;
            }
            setTimeout(() => {
                errorHandler(userCurrentTime, audioCurrentTime, progressWidth);
                progressContainer.addEventListener('click', setProgress);
            }, 200);
        }
        progressContainer.addEventListener('click', setProgress);

        function errorHandler(userCurrentTime, currentTime, progressWidth){
            if (Math.floor(audio.currentTime) == 0){
                console.log("LOAD MUSIC");
                progress.classList.add('loadMusicAnim');
                audio.pause();
                audio.removeEventListener('timeupdate', updateProgress);
                progress.style.width = progressWidth;
                audio.muted = true;
                audio.playbackRate = 16;
                audio.play();
                setTimeout(() => {
                    progress.classList.remove('loadMusicAnim');
                    audio.muted = false;
                    audio.playbackRate = 1;
                    audio.addEventListener('timeupdate', updateProgress);
                }, (userCurrentTime / 16) * 1000);
            }
        }        
        // Звук
        audio.volume = 1;
        volumeControl.addEventListener('input', function() {
            const volume = parseFloat(this.value);
            if (volume == 0){
                volumeControlIco.style.background = "url('../../static/cm_site/img/v1.svg')";
                volumeControlIco.style.backgroundSize = "cover";
                volumeControlIco.style.backgroundRepeat = "no-repeat";
            } else {
                if (volume < 0.33){
                    volumeControlIco.style.background = "url('../../static/cm_site/img/v2.svg')";
                    volumeControlIco.style.backgroundSize = "cover";
                    volumeControlIco.style.backgroundRepeat = "no-repeat";
                } else {
                    if (volume < 0.66){
                        volumeControlIco.style.background = "url('../../static/cm_site/img/v3.svg')";
                        volumeControlIco.style.backgroundSize = "cover";
                        volumeControlIco.style.backgroundRepeat = "no-repeat";
                    } else {
                        volumeControlIco.style.background = "url('../../static/cm_site/img/p-vol.svg')";
                        volumeControlIco.style.backgroundSize = "cover";
                        volumeControlIco.style.backgroundRepeat = "no-repeat";
                    }
                }
            }
            audio.volume = volume;
        });

        function coverPlay(index){
            if (songIndex != index - 1){
                let classDel;
                let innerClassDel;
                for (let i = 1; i <= songs.length; i++) {
                    innerClassDel = document.querySelector(`.music:nth-child(${i}) .music__cover_button`);
                    classDel = document.querySelector(`.music:nth-child(${i})`);
                    classDel.classList.remove('operated');
                    innerClassDel.classList.remove('music__cover_button-active');
                }
            }
            const musicButton = document.querySelector(`.music:nth-child(${index})`);
            const isOperated = musicButton.classList.contains('operated');
            const musicCoverButton = document.querySelector(`.music:nth-child(${index}) .music__cover_button`);
            if (isOperated){
                const isPlaing = musicButton.classList.contains('playSong');
                if (isPlaing){
                    musicCoverButton.classList.remove('music__cover_button-active');
                    musicButton.classList.remove('playSong');
                    pauseSong();
                } else {
                    musicCoverButton.classList.add('music__cover_button-active');
                    musicButton.classList.add('playSong');
                    playSong();
                }
            } else {
                console.log('init');
                musicButton.classList.add('operated');
                musicButton.classList.add('playSong');
                musicCoverButton.classList.add('music__cover_button-active');
                songIndex = index - 1;
                loadSong(songIndex);
                playSong(songIndex);
            }
        }
    </script>
    <!-- Скрипт Баннеров -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const slides = document.querySelectorAll(".carousel__slide");
            let currentSlide = 0;
            function showSlide(slideIndex) {
                slides.forEach((slide, index) => {
                    if (index === slideIndex) {
                        slide.style.display = "block";
                    } else {
                        slide.style.display = "none";
                    }
                });
            }
            function nextSlide() {
                currentSlide = (currentSlide + 1) % slides.length;
                showSlide(currentSlide);
            }
            showSlide(currentSlide);
            setInterval(nextSlide, 5000);
        });
    </script>
</body>
</html>